- hosts: master
  gather_facts: false
  tasks:
 
  Check if partiton exists
# https://docs.ansible.com/ansible/latest/collections/community/general/parted_module.html
  - name: Read device information
    become: true
    community.general.parted: device=/dev/sdc unit=MiB
    register: sdc_info
    async: 10
    poll: 2
 
# Create partition
# https://docs.ansible.com/ansible/latest/collections/community/general/parted_module.html
  - name: Debug sdc_info
    ansible.builtin.debug:
      var: sdc_info.partitions
    when:
      - sdc_info.partitions | length == 0

  - name: Create a new primary partition
    become: true
    community.general.parted:
      device: /dev/sdc
      number: 1
      state: present
    async: 300
    poll: 5
    when: sdc_info.partitions | length == 0
    register: nfs_partition

# Create logical volume
# https://docs.ansible.com/ansible/latest/collections/community/general/lvol_module.html 
  - name: Create Volume Group on /dev/sdc with physical extent size = 10g
    become: true  
    community.general.lvg:
      vg: nfs-vg
      pvs: /dev/sdc1
      force: no
      state: present
    async: 10
    poll: 2
    when: nfs_partition.changed

  - name: Create a logical volume
    become: true
    community.general.lvol:
      vg: nfs-vg
      lv: nfs-lv
      size: 100%FREE
      force: no
      state: present
    async: 10
    poll: 2
    when: nfs_partition.changed


  - name: Create xfs filesystem on nfs data partition
    become: true
    community.general.filesystem:
      fstype: xfs
      dev: /dev/nfs-vg/nfs-lv
      force: yes
    async: 300
    poll: 5
    when: nfs_partition.changed

